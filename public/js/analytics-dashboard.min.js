class AnalyticsDashboard{constructor(){this.charts={};this.init();}init(){this.setupEventListeners();this.initCharts();this.setupModals();this.setupAutoRefresh();}setupEventListeners(){const exportBtn=document.getElementById('export-data-btn');if(exportBtn){exportBtn.addEventListener('click',()=>this.openExportModal());}const activityPeriod=document.getElementById('activity-period');if(activityPeriod){activityPeriod.addEventListener('change',(e)=>{this.updateActivityChart(e.target.value);});}const closeModal=document.getElementById('close-export-modal');const cancelExport=document.getElementById('cancel-export');const confirmExport=document.getElementById('confirm-export');if(closeModal){closeModal.addEventListener('click',()=>this.closeExportModal());}if(cancelExport){cancelExport.addEventListener('click',()=>this.closeExportModal());}if(confirmExport){confirmExport.addEventListener('click',()=>this.exportData());}const modal=document.getElementById('export-modal');if(modal){modal.addEventListener('click',(e)=>{if(e.target===modal){this.closeExportModal();}});}document.addEventListener('keydown',(e)=>{if(e.key==='Escape'){this.closeExportModal();}});}initCharts(){this.initActivityChart();this.initProgressChart();this.animateMetrics();}initActivityChart(){const ctx=document.getElementById('activity-chart');if(!ctx||!window.analyticsData?.recentActivity)return;const data=window.analyticsData.recentActivity;const chartData=this.prepareActivityData(data);this.charts.activity=new Chart(ctx,{type:'line',data:{labels:chartData.labels,datasets:[{label:'Aulas Concluídas',data:chartData.values,borderColor:'#8B5CF6',backgroundColor:'rgba(139,92,246,0.1)',borderWidth:3,fill:!0,tension:0.4,pointBackgroundColor:'#8B5CF6',pointBorderColor:'#FFFFFF',pointBorderWidth:2,pointRadius:6,pointHoverRadius:8}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#FFFFFF',bodyColor:'#FFFFFF',borderColor:'#8B5CF6',borderWidth:1,cornerRadius:8,displayColors:!1,callbacks:{title:function(context){return `${context[0].label}`;},label:function(context){const value=context.parsed.y;return `${value}aula${value!==1?'s':''}concluída${value!==1?'s':''}`;}}}},scales:{x:{grid:{display:!1},ticks:{color:'#64748B',font:{size:12}}},y:{beginAtZero:!0,grid:{color:'rgba(226,232,240,0.5)'},ticks:{color:'#64748B',font:{size:12},stepSize:1}}},elements:{point:{hoverBorderWidth:3}},interaction:{intersect:!1,mode:'index'}}});}initProgressChart(){const ctx=document.getElementById('progress-chart');if(!ctx||!window.analyticsData?.packageProgress)return;const data=window.analyticsData.packageProgress;const chartData=this.prepareProgressData(data);this.charts.progress=new Chart(ctx,{type:'doughnut',data:{labels:chartData.labels,datasets:[{data:chartData.values,backgroundColor:['#8B5CF6','#A78BFA','#C4B5FD','#DDD6FE','#EDE9FE','#F3F4F6'],borderColor:'#FFFFFF',borderWidth:2,hoverBorderWidth:3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:'bottom',labels:{color:'#64748B',font:{size:12},padding:20,usePointStyle:!0,pointStyle:'circle'}},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#FFFFFF',bodyColor:'#FFFFFF',borderColor:'#8B5CF6',borderWidth:1,cornerRadius:8,callbacks:{label:function(context){const percentage=context.parsed;return `${context.label}:${percentage}%`;}}}},cutout:'60%',elements:{arc:{borderRadius:4}}}});}prepareActivityData(data){if(!data||data.length===0){return{labels:['Sem dados'],values:[0]};}const sortedData=data.sort((a,b)=>new Date(a.date)-new Date(b.date));const labels=sortedData.map(item=>{const date=new Date(item.date);return date.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});});const values=sortedData.map(item=>item.lessons_completed||0);return{labels,values};}prepareProgressData(data){if(!data||data.length===0){return{labels:['Sem dados'],values:[100]};}const labels=data.map(item=>item.name);const values=data.map(item=>parseFloat(item.completion_percentage)||0);return{labels,values};}async updateActivityChart(period){this.showLoading();try{const response=await fetch(`/analytics/api/chart-data?type=activity&period=${period}`);const result=await response.json();if(result.success&&this.charts.activity){const chartData=this.prepareActivityData(result.data);this.charts.activity.data.labels=chartData.labels;this.charts.activity.data.datasets[0].data=chartData.values;this.charts.activity.update('active');}}catch(error){console.error('Erro ao atualizar gráfico de atividade:',error);this.showError('Erro ao atualizar gráfico');}finally{this.hideLoading();}}animateMetrics(){const metricValues=document.querySelectorAll('.metric-value');metricValues.forEach(element=>{const finalValue=parseFloat(element.textContent.replace(/[^\d.]/g,''));if(isNaN(finalValue))return;let currentValue=0;const increment=finalValue/50;const duration=1500;const frameTime=duration/50;const timer=setInterval(()=>{currentValue+=increment;if(currentValue>=finalValue){currentValue=finalValue;clearInterval(timer);}if(element.textContent.includes('%')){element.textContent=Math.round(currentValue)+'%';}else if(element.textContent.includes('XP')){element.textContent=Math.round(currentValue).toLocaleString();}else{element.textContent=Math.round(currentValue);}},frameTime);});}setupModals(){}openExportModal(){const modal=document.getElementById('export-modal');if(modal){modal.classList.add('active');document.body.style.overflow='hidden';}}closeExportModal(){const modal=document.getElementById('export-modal');if(modal){modal.classList.remove('active');document.body.style.overflow='';}}async exportData(){const period=document.getElementById('export-period').value;const format=document.getElementById('export-format').value;this.showLoading();try{const response=await fetch(`/analytics/api/export?period=${period}&format=${format}`);if(response.ok){const blob=await response.blob();const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`analytics_${period}.${format}`;document.body.appendChild(a);a.click();window.URL.revokeObjectURL(url);document.body.removeChild(a);this.closeExportModal();this.showSuccess('Dados exportados com sucesso!');}else{throw new Error('Erro ao exportar dados');}}catch(error){console.error('Erro ao exportar dados:',error);this.showError('Erro ao exportar dados');}finally{this.hideLoading();}}setupAutoRefresh(){setInterval(()=>{this.refreshMetrics();},5*60*1000);}async refreshMetrics(){try{const response=await fetch('/analytics/api/user');const result=await response.json();if(result.success){this.updateMetricsDisplay(result.data);}}catch(error){console.error('Erro ao atualizar métricas:',error);}}updateMetricsDisplay(data){const xpElement=document.querySelector('.metric-icon.xp+.metric-info .metric-value');if(xpElement&&data.user){xpElement.textContent=data.user.xp_points;}const lessonsElement=document.querySelector('.metric-icon.lessons+.metric-info .metric-value');if(lessonsElement&&data.user){lessonsElement.textContent=data.user.lessons_completed;}const streakElement=document.querySelector('.metric-icon.streak+.metric-info .metric-value');if(streakElement&&data.current_streak!==undefined){streakElement.textContent=data.current_streak;}const performanceElement=document.querySelector('.metric-icon.performance+.metric-info .metric-value');if(performanceElement&&data.performance_metrics){performanceElement.textContent=data.performance_metrics.avg_quiz_score+'%';}}showLoading(){const overlay=document.getElementById('loading-overlay');if(overlay){overlay.style.display='flex';}}hideLoading(){const overlay=document.getElementById('loading-overlay');if(overlay){overlay.style.display='none';}}showSuccess(message){this.showNotification(message,'success');}showError(message){this.showNotification(message,'error');}showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`notification notification-${type}`;notification.innerHTML=`<div class="notification-content"><i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i><span>${message}</span></div><button class="notification-close"><i class="fas fa-times"></i></button>`;notification.style.cssText=` position:fixed;top:20px;right:20px;background:${type==='success'?'#10B981':type==='error'?'#EF4444':'#8B5CF6'};color:white;padding:1rem 1.5rem;border-radius:8px;box-shadow:0 10px 15px-3px rgba(0,0,0,0.1);z-index:10000;display:flex;align-items:center;justify-content:space-between;gap:1rem;max-width:400px;animation:slideIn 0.3s ease-out;`;document.body.appendChild(notification);const closeBtn=notification.querySelector('.notification-close');closeBtn.addEventListener('click',()=>{notification.remove();});setTimeout(()=>{if(notification.parentNode){notification.remove();}},5000);if(!document.querySelector('#notification-styles')){const styles=document.createElement('style');styles.id='notification-styles';styles.textContent=` @keyframes slideIn{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}.notification-content{display:flex;align-items:center;gap:0.5rem;}.notification-close{background:none;border:none;color:white;cursor:pointer;padding:0.25rem;border-radius:4px;opacity:0.8;transition:opacity 0.2s;}.notification-close:hover{opacity:1;}`;document.head.appendChild(styles);}}destroy(){Object.values(this.charts).forEach(chart=>{if(chart&&typeof chart.destroy==='function'){chart.destroy();}});this.charts={};}}document.addEventListener('DOMContentLoaded',()=>{window.analyticsDashboard=new AnalyticsDashboard();});window.addEventListener('beforeunload',()=>{if(window.analyticsDashboard){window.analyticsDashboard.destroy();}});