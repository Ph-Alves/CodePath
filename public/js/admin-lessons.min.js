console.log('üîç[DEBUG]Script admin-lessons.js carregando...');console.log('üöÄ[ADMIN-LESSONS]Carregando AdminLessonsManager...');class AdminLessonsManager{constructor(){console.log('üîß[ADMIN-LESSONS]Construtor chamado');this.lessons=[];this.packages=[];this.filteredLessons=[];this.isInitialized=!1;window.adminLessonsManager=this;this.init();}async init(){console.log('üîÑ[ADMIN-LESSONS]Inicializando...');if(this.isInitialized){console.log('‚ö†Ô∏è[ADMIN-LESSONS]J√° inicializado,pulando...');return;}try{await this.loadPackages();await this.loadLessons();this.setupEventListeners();this.applyFilters();this.isInitialized=!0;console.log('‚úÖ[ADMIN-LESSONS]Inicializa√ß√£o completa!');}catch(error){console.error('‚ùå[ADMIN-LESSONS]Erro na inicializa√ß√£o:',error);}}async loadPackages(){try{console.log('üì¶[ADMIN-LESSONS]Carregando pacotes...');const response=await fetch('/admin/api/packages');if(!response.ok){throw new Error(`Erro ao carregar pacotes:${response.status}`);}const data=await response.json();this.packages=data.packages||[];console.log(`üì¶[ADMIN-LESSONS]${this.packages.length}pacotes carregados`);}catch(error){console.error('‚ùå[ADMIN-LESSONS]Erro ao carregar pacotes:',error);this.packages=[];}}async loadLessons(){try{console.log('üìö[ADMIN-LESSONS]Carregando aulas...');const response=await fetch('/admin/api/lessons');if(!response.ok){throw new Error(`Erro ao carregar aulas:${response.status}`);}const data=await response.json();this.lessons=data.lessons||[];this.filteredLessons=[...this.lessons];this.renderLessons();console.log(`üìö[ADMIN-LESSONS]${this.lessons.length}aulas carregadas`);}catch(error){console.error('‚ùå[ADMIN-LESSONS]Erro ao carregar aulas:',error);this.lessons=[];this.filteredLessons=[];this.showEmptyState();}}setupEventListeners(){console.log('üéØ[ADMIN-LESSONS]Configurando event listeners...');const searchInput=document.getElementById('searchLessons');const packageFilter=document.getElementById('filterPackage');const sortSelect=document.getElementById('sortLessons');const resetBtn=document.getElementById('resetFilters');const clearFiltersBtn=document.getElementById('clearFiltersBtn');if(searchInput){searchInput.addEventListener('input',()=>this.applyFilters());}if(packageFilter){packageFilter.addEventListener('change',()=>this.applyFilters());}if(sortSelect){sortSelect.addEventListener('change',()=>this.applyFilters());}if(resetBtn){resetBtn.addEventListener('click',()=>this.resetFilters());}if(clearFiltersBtn){clearFiltersBtn.addEventListener('click',()=>this.resetFilters());}document.addEventListener('click',(e)=>{if(e.target.classList.contains('edit-lesson-btn')||e.target.closest('.edit-lesson-btn')){e.preventDefault();const btn=e.target.closest('.edit-lesson-btn')||e.target;const lessonId=parseInt(btn.dataset.lessonId);const lessonName=btn.dataset.lessonName;console.log('‚úèÔ∏è[ADMIN-LESSONS]Clique em editar:',lessonId,lessonName);this.editLessonName(lessonId,lessonName);}if(e.target.classList.contains('delete-lesson-btn')||e.target.closest('.delete-lesson-btn')){e.preventDefault();const btn=e.target.closest('.delete-lesson-btn')||e.target;const lessonId=parseInt(btn.dataset.lessonId);const lessonName=btn.dataset.lessonName;console.log('üóëÔ∏è[ADMIN-LESSONS]Clique em excluir:',lessonId,lessonName);this.deleteLesson(lessonId,lessonName);}});console.log('‚úÖ[ADMIN-LESSONS]Event listeners configurados');}renderLessons(){console.log(`üé®[ADMIN-LESSONS]Renderizando ${this.filteredLessons.length}aulas...`);const tableBody=document.getElementById('lessonsTableBody');const emptyState=document.getElementById('emptyState');if(!tableBody){console.error('‚ùå[ADMIN-LESSONS]Elemento lessonsTableBody n√£o encontrado');return;}if(this.filteredLessons.length===0){tableBody.innerHTML='';if(emptyState)emptyState.style.display='block';return;}if(emptyState)emptyState.style.display='none';const html=this.filteredLessons.map(lesson=>{const packageInfo=this.packages.find(p=>p.id===lesson.package_id)||{name:'Pacote n√£o encontrado',icon:'fas fa-box'};return `<tr data-lesson-id="${lesson.id}" data-package-id="${lesson.package_id}" class="lesson-row"><td class="drag-handle"><i class="fas fa-grip-vertical text-muted"></i></td><td><div class="lesson-info"><div class="lesson-name">${lesson.name}</div><div class="lesson-description">${lesson.description||'Sem descri√ß√£o dispon√≠vel'}</div></div></td><td><div class="package-info"><i class="${packageInfo.icon||'fas fa-box'}text-primary"></i><span>${packageInfo.name}</span></div></td><td><span class="badge bg-secondary">${lesson.lesson_number}/${lesson.order_sequence}</span></td><td><div class="completion-stats"><div class="progress mb-2"><div class="progress-bar" style="width:${lesson.completion_rate||0}%"></div></div><small class="text-muted">${lesson.completion_rate||0}%(${lesson.completion_count||0}usu√°rios)</small></div></td><td><div class="action-buttons"><button class="btn btn-sm btn-outline-primary edit-lesson-btn" data-lesson-id="${lesson.id}" data-lesson-name="${lesson.name}" title="Editar Nome">‚úèÔ∏è</button><button class="btn btn-sm btn-outline-danger delete-lesson-btn" data-lesson-id="${lesson.id}" data-lesson-name="${lesson.name}" title="Excluir">üóëÔ∏è</button></div></td></tr>`;}).join('');tableBody.innerHTML=html;console.log('‚úÖ[ADMIN-LESSONS]Renderiza√ß√£o completa');}applyFilters(){const searchTerm=document.getElementById('searchLessons')?.value.toLowerCase()||'';const packageFilter=document.getElementById('filterPackage')?.value||'';const sortBy=document.getElementById('sortLessons')?.value||'package_order';this.filteredLessons=this.lessons.filter(lesson=>{const matchesSearch=lesson.name.toLowerCase().includes(searchTerm);const matchesPackage=!packageFilter||lesson.package_id.toString()===packageFilter;return matchesSearch&&matchesPackage;});this.filteredLessons.sort((a,b)=>{switch(sortBy){case 'name':return a.name.localeCompare(b.name);case 'completion_rate':return(b.completion_rate||0)-(a.completion_rate||0);case 'created_at':return new Date(b.created_at)-new Date(a.created_at);default:if(a.package_id!==b.package_id){return a.package_id-b.package_id;}return(a.lesson_number||0)-(b.lesson_number||0);}});this.renderLessons();}resetFilters(){const searchInput=document.getElementById('searchLessons');const packageFilter=document.getElementById('filterPackage');const sortSelect=document.getElementById('sortLessons');if(searchInput)searchInput.value='';if(packageFilter)packageFilter.value='';if(sortSelect)sortSelect.value='package_order';this.applyFilters();}async editLessonName(lessonId,currentName){console.log('‚úèÔ∏è[ADMIN-LESSONS]Iniciando edi√ß√£o da aula:',lessonId,currentName);const newName=prompt(`Editar nome da aula:\n\nNome atual:${currentName}\n\nDigite o novo nome:`,currentName);console.log('üìù[ADMIN-LESSONS]Nome inserido pelo usu√°rio:',newName);if(!newName||newName.trim()===''||newName===currentName){console.log('‚ùå[ADMIN-LESSONS]Edi√ß√£o cancelada ou nome n√£o alterado');return;}if(newName.trim().length<3){this.showNotification('‚ùå Nome deve ter pelo menos 3 caracteres','error');return;}try{const updateData={name:newName.trim()};console.log('üì§[ADMIN-LESSONS]Enviando dados:',updateData);const response=await fetch(`/admin/api/lessons/${lessonId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(updateData)});console.log(`üì•[ADMIN-LESSONS]Status da resposta:${response.status}`);const responseData=await response.json();console.log('üìã[ADMIN-LESSONS]Dados da resposta:',responseData);if(!response.ok){throw new Error(responseData.message||`Erro HTTP:${response.status}`);}const lessonIndex=this.lessons.findIndex(l=>l.id===lessonId);if(lessonIndex!==-1){this.lessons[lessonIndex].name=newName.trim();console.log('üìù[ADMIN-LESSONS]Dados locais atualizados');}this.applyFilters();this.showNotification(`‚úÖ Nome da aula alterado para:"${newName.trim()}"`,'success');}catch(error){console.error('‚ùå[ADMIN-LESSONS]Erro ao editar aula:',error);this.showNotification(`‚ùå Erro ao editar aula:${error.message}`,'error');}}async deleteLesson(lessonId,lessonName){console.log('üóëÔ∏è[ADMIN-LESSONS]Iniciando exclus√£o da aula:',lessonId,lessonName);const confirmDelete=confirm(`Tem certeza que deseja excluir a aula?\n\n"${lessonName}"\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!`);if(!confirmDelete){console.log('üö´[ADMIN-LESSONS]Usu√°rio cancelou a exclus√£o');return;}try{console.log(`üóëÔ∏è[ADMIN-LESSONS]Excluindo aula ${lessonId}-${lessonName}...`);const response=await fetch(`/admin/api/lessons/${lessonId}`,{method:'DELETE'});console.log(`üì•[ADMIN-LESSONS]Resposta da exclus√£o:${response.status}`);if(!response.ok){const errorData=await response.json();throw new Error(errorData.message||`Erro HTTP:${response.status}`);}const result=await response.json();console.log('‚úÖ[ADMIN-LESSONS]Resultado da exclus√£o:',result);this.lessons=this.lessons.filter(l=>l.id!==lessonId);this.applyFilters();this.showNotification(`üóëÔ∏è Aula "${lessonName}" exclu√≠da com sucesso`,'success');}catch(error){console.error('‚ùå[ADMIN-LESSONS]Erro ao excluir aula:',error);this.showNotification(`‚ùå Erro ao excluir aula:${error.message}`,'error');}}showNotification(message,type='success'){console.log(`üì¢[ADMIN-LESSONS]Notifica√ß√£o:${message}(${type})`);const existingNotifications=document.querySelectorAll('.admin-notification');existingNotifications.forEach(n=>n.remove());const notification=document.createElement('div');notification.className=`alert alert-${type==='success'?'success':'danger'}alert-dismissible fade show position-fixed admin-notification`;notification.style.cssText='top:20px;right:20px;z-index:9999;min-width:300px;max-width:500px;';notification.innerHTML=` ${message}<button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>`;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentElement){notification.remove();}},5000);}showEmptyState(){const tableBody=document.getElementById('lessonsTableBody');const emptyState=document.getElementById('emptyState');if(tableBody)tableBody.innerHTML='';if(emptyState)emptyState.style.display='block';}}console.log('üîç[ADMIN-LESSONS]Configurando inicializa√ß√£o...');function initializeAdminLessons(){if(window.adminLessonsManager){console.log('‚úÖ[ADMIN-LESSONS]Inst√¢ncia j√° existe,n√£o duplicando');return;}console.log('üöÄ[ADMIN-LESSONS]Criando nova inst√¢ncia...');try{new AdminLessonsManager();}catch(error){console.error('‚ùå[ADMIN-LESSONS]Erro na inicializa√ß√£o:',error);}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initializeAdminLessons);}else{initializeAdminLessons();}window.addEventListener('load',()=>{console.log('üîÑ[ADMIN-LESSONS]Window load completo,verificando inicializa√ß√£o...');if(!window.adminLessonsManager){console.log('‚ö†Ô∏è[ADMIN-LESSONS]Backup:inicializando via window.load...');initializeAdminLessons();}});console.log('üîç[ADMIN-LESSONS]Inicializadores configurados!');