class AchievementManager{constructor(){this.modal=null;this.loadingOverlay=null;this.currentFilter='all';this.currentSearch='';this.checkInterval=null;this.achievements=[];this.filteredAchievements=[];this.init();}init(){console.log('[ACHIEVEMENTS]Inicializando sistema de conquistas avan√ßado...');this.modal=document.getElementById('achievementModal');this.loadingOverlay=document.getElementById('loadingOverlay');this.loadInitialData();this.setupEventListeners();this.loadAchievementProgress();this.updateStreak();this.startAutoCheck();this.setupSearchSystem();console.log('[ACHIEVEMENTS]Sistema inicializado com sucesso!');}async loadInitialData(){try{const response=await fetch('/achievements/api/user');const data=await response.json();if(data.success){this.achievements=data.data.achievements;this.filteredAchievements=[...this.achievements];console.log('[ACHIEVEMENTS]Dados carregados:',this.achievements.length,'conquistas');}}catch(error){console.error('[ACHIEVEMENTS]Erro ao carregar dados iniciais:',error);}}setupSearchSystem(){const header=document.querySelector('.achievements-header');if(header&&!document.querySelector('.search-container')){const searchContainer=document.createElement('div');searchContainer.className='search-container';searchContainer.innerHTML=`<div class="search-box"><input type="text" id="achievementSearch" placeholder="Buscar conquistas..." class="search-input"><span class="search-icon">üîç</span></div><div class="search-filters"><button class="filter-status active" data-status="all">Todas</button><button class="filter-status" data-status="unlocked">Desbloqueadas</button><button class="filter-status" data-status="locked">Pendentes</button></div>`;const categoryFilters=document.querySelector('.category-filters');if(categoryFilters){categoryFilters.parentNode.insertBefore(searchContainer,categoryFilters.nextSibling);}const searchInput=document.getElementById('achievementSearch');if(searchInput){searchInput.addEventListener('input',(e)=>{this.currentSearch=e.target.value.toLowerCase();this.applyFilters();});}const statusFilters=document.querySelectorAll('.filter-status');statusFilters.forEach(btn=>{btn.addEventListener('click',(e)=>{statusFilters.forEach(b=>b.classList.remove('active'));e.target.classList.add('active');this.applyFilters();});});}}setupEventListeners(){const filterButtons=document.querySelectorAll('.filter-btn');filterButtons.forEach(btn=>{btn.addEventListener('click',(e)=>{this.filterAchievements(e.target.dataset.category);});});const achievementCards=document.querySelectorAll('.achievement-card');achievementCards.forEach(card=>{card.addEventListener('click',(e)=>{const achievementId=card.dataset.achievementId;this.showAchievementDetails(achievementId);});card.addEventListener('mouseenter',()=>{this.addHoverEffect(card);});card.addEventListener('mouseleave',()=>{this.removeHoverEffect(card);});});if(this.modal){const closeBtn=this.modal.querySelector('.modal-close');const continueBtn=this.modal.querySelector('.modal-continue');closeBtn?.addEventListener('click',()=>this.hideModal());continueBtn?.addEventListener('click',()=>this.hideModal());this.modal.addEventListener('click',(e)=>{if(e.target===this.modal){this.hideModal();}});}document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&this.modal?.classList.contains('show')){this.hideModal();}});document.addEventListener('keydown',(e)=>{if(e.ctrlKey||e.metaKey){switch(e.key){case '1':this.filterAchievements('beginner');e.preventDefault();break;case '2':this.filterAchievements('progress');e.preventDefault();break;case '3':this.filterAchievements('mastery');e.preventDefault();break;case '4':this.filterAchievements('streak');e.preventDefault();break;case '5':this.filterAchievements('social');e.preventDefault();break;case '6':this.filterAchievements('special');e.preventDefault();break;case '0':this.filterAchievements('all');e.preventDefault();break;}}});}applyFilters(){const activeStatusFilter=document.querySelector('.filter-status.active')?.dataset.status||'all';let filtered=this.currentFilter==='all'?[...this.achievements]:this.achievements.filter(a=>a.category===this.currentFilter);if(activeStatusFilter!=='all'){filtered=filtered.filter(a=>{return activeStatusFilter==='unlocked'?a.is_unlocked:!a.is_unlocked;});}if(this.currentSearch){filtered=filtered.filter(a=>a.name.toLowerCase().includes(this.currentSearch)||a.description.toLowerCase().includes(this.currentSearch)||a.category.toLowerCase().includes(this.currentSearch));}this.filteredAchievements=filtered;this.updateAchievementDisplay();}updateAchievementDisplay(){const sections=document.querySelectorAll('.category-section');sections.forEach(section=>{const category=section.dataset.category;const categoryAchievements=this.filteredAchievements.filter(a=>a.category===category);if(categoryAchievements.length>0&&(this.currentFilter==='all'||this.currentFilter===category)){section.style.display='block';section.classList.remove('hidden');const achievementsRow=section.querySelector('.achievements-row');if(achievementsRow){const cards=achievementsRow.querySelectorAll('.achievement-card');cards.forEach(card=>{const cardId=parseInt(card.dataset.achievementId);const shouldShow=categoryAchievements.some(a=>a.id===cardId);if(shouldShow){card.style.display='block';card.classList.remove('filtered-out');}else{card.style.display='none';card.classList.add('filtered-out');}});}}else{section.style.display='none';section.classList.add('hidden');}});this.showEmptyState();this.animateFilteredResults();}showEmptyState(){const visibleCards=document.querySelectorAll('.achievement-card:not(.filtered-out):not([style*="display:none"])');let emptyState=document.querySelector('.empty-achievements-state');if(visibleCards.length===0){if(!emptyState){emptyState=document.createElement('div');emptyState.className='empty-achievements-state';emptyState.innerHTML=`<div class="empty-state-content"><div class="empty-state-icon">üîç</div><h3>Nenhuma conquista encontrada</h3><p>Tente ajustar os filtros ou termo de busca</p><button class="btn-secondary" onclick="achievementManager.clearFilters()">Limpar Filtros</button></div>`;const grid=document.querySelector('.achievements-grid');if(grid){grid.appendChild(emptyState);}}emptyState.style.display='block';}else{if(emptyState){emptyState.style.display='none';}}}clearFilters(){const searchInput=document.getElementById('achievementSearch');if(searchInput){searchInput.value='';this.currentSearch='';}this.filterAchievements('all');const statusFilters=document.querySelectorAll('.filter-status');statusFilters.forEach(btn=>btn.classList.remove('active'));document.querySelector('.filter-status[data-status="all"]')?.classList.add('active');this.applyFilters();}animateFilteredResults(){const visibleSections=document.querySelectorAll('.category-section:not(.hidden)');visibleSections.forEach((section,index)=>{section.style.opacity='0';section.style.transform='translateY(20px)';setTimeout(()=>{section.style.transition='all 0.4s ease';section.style.opacity='1';section.style.transform='translateY(0)';},index*100);});}filterAchievements(category){console.log('[ACHIEVEMENTS]Filtrando por categoria:',category);this.currentFilter=category;document.querySelectorAll('.filter-btn').forEach(btn=>{btn.classList.remove('active');});document.querySelector(`[data-category="${category}"]`)?.classList.add('active');this.applyFilters();}addHoverEffect(card){if(!card.classList.contains('unlocked')){card.style.transform='translateY(-8px)scale(1.02)';card.style.boxShadow='0 12px 40px rgba(139,69,255,0.3)';}else{card.style.transform='translateY(-5px)scale(1.01)';card.style.boxShadow='0 8px 30px rgba(34,197,94,0.3)';}}removeHoverEffect(card){card.style.transform='';card.style.boxShadow='';}async loadAchievementProgress(){console.log('[ACHIEVEMENTS]Carregando progresso das conquistas...');const lockedCards=document.querySelectorAll('.achievement-card:not(.unlocked)');for(const card of lockedCards){const achievementId=card.dataset.achievementId;try{const response=await fetch(`/achievements/api/progress/${achievementId}`);const data=await response.json();if(data.success){this.updateProgressBar(card,data.data);}}catch(error){console.error('[ACHIEVEMENTS]Erro ao carregar progresso:',error);}}}updateProgressBar(card,progressData){const progressBar=card.querySelector('.progress-fill-small');const progressText=card.querySelector('.progress-text-small');if(progressBar&&progressText){const percentage=progressData.progressPercentage;setTimeout(()=>{progressBar.style.width=`${percentage}%`;progressBar.style.transition='width 1.5s ease-out';},100);progressText.textContent=`${percentage}%(${progressData.currentValue}/${progressData.targetValue})`;if(percentage>=80){progressBar.classList.add('high-progress');card.classList.add('near-completion');}}}async showAchievementDetails(achievementId){console.log('[ACHIEVEMENTS]Mostrando detalhes da conquista:',achievementId);try{const response=await fetch(`/achievements/api/progress/${achievementId}`);const data=await response.json();if(data.success){const achievement=data.data;if(achievement.achievement.is_unlocked){this.showUnlockedAchievementDetails(achievement);}else{this.showProgressDetails(achievement);}}}catch(error){console.error('[ACHIEVEMENTS]Erro ao buscar detalhes:',error);}}showUnlockedAchievementDetails(achievement){const modal=this.modal;if(!modal)return;modal.querySelector('.modal-title').textContent='üéâ Conquista Desbloqueada!';modal.querySelector('.modal-achievement-icon').textContent=achievement.achievement.icon;modal.querySelector('.modal-achievement-name').textContent=achievement.achievement.name;modal.querySelector('.modal-achievement-description').textContent=achievement.achievement.description;modal.querySelector('.xp-amount').textContent=`+${achievement.achievement.xp_reward}XP`;const modalBody=modal.querySelector('.modal-body');let extraInfo=modalBody.querySelector('.extra-info');if(!extraInfo){extraInfo=document.createElement('div');extraInfo.className='extra-info';modalBody.appendChild(extraInfo);}extraInfo.innerHTML=`<div class="achievement-category"><span class="category-badge ${achievement.achievement.category}">${this.getCategoryName(achievement.achievement.category)}</span></div><div class="unlock-date">Desbloqueada em ${achievement.achievement.unlocked_at||'Data n√£o dispon√≠vel'}</div>`;this.showModal();}showProgressDetails(achievement){const modal=this.modal;if(!modal)return;modal.querySelector('.modal-title').textContent='üìä Progresso da Conquista';modal.querySelector('.modal-achievement-icon').textContent=achievement.achievement.icon;modal.querySelector('.modal-achievement-name').textContent=achievement.achievement.name;modal.querySelector('.modal-achievement-description').textContent=achievement.achievement.description;modal.querySelector('.xp-amount').textContent=`+${achievement.achievement.xp_reward}XP`;const modalBody=modal.querySelector('.modal-body');let progressInfo=modalBody.querySelector('.progress-info');if(!progressInfo){progressInfo=document.createElement('div');progressInfo.className='progress-info';modalBody.appendChild(progressInfo);}progressInfo.innerHTML=`<div class="modal-progress-section"><div class="progress-header"><span>Progresso:${achievement.currentValue}/${achievement.targetValue}</span><span class="progress-percentage">${achievement.progressPercentage}%</span></div><div class="progress-bar-modal"><div class="progress-fill-modal" style="width:${achievement.progressPercentage}%"></div></div><div class="progress-tips">${this.getProgressTips(achievement.achievement)}</div></div>`;this.showModal();}getCategoryName(category){const categories={'beginner':'Iniciante','progress':'Progresso','mastery':'Maestria','streak':'Consist√™ncia','social':'Social','special':'Especiais'};return categories[category]||category;}getProgressTips(achievement){const tips={'lessons_completed':'üí° Dica:Continue assistindo √†s aulas para desbloquear esta conquista!','quizzes_completed':'üß† Dica:Fa√ßa mais question√°rios para testar seus conhecimentos!','packages_completed':'üì¶ Dica:Complete todos os m√≥dulos de um pacote para conquistar!','streak_days':'üî• Dica:Estude todos os dias para manter seu streak!','total_xp':'‚ö° Dica:Ganhe XP completando aulas e question√°rios!','perfect_quizzes':'üéØ Dica:Acerte 100%dos question√°rios para esta conquista!','study_hours':'‚è∞ Dica:Continue estudando para acumular horas de estudo!'};return tips[achievement.requirement_type]||'üí™ Continue se dedicando aos estudos!';}async updateStreak(){try{const response=await fetch('/achievements/api/streak',{method:'POST'});const data=await response.json();if(data.success){this.updateStreakDisplay(data.data);if(data.data.newAchievements&&data.data.newAchievements.length>0){data.data.newAchievements.forEach(achievement=>{setTimeout(()=>this.showAchievementUnlocked(achievement),1000);});}}}catch(error){console.error('[ACHIEVEMENTS]Erro ao atualizar streak:',error);}}updateStreakDisplay(streakData){const streakElements=document.querySelectorAll('.stat-number');streakElements.forEach(element=>{const parent=element.closest('.streak-card');if(parent){element.innerHTML=`<span class="streak-icon">üî•</span>${streakData.streak}`;if(streakData.isNewDay){element.classList.add('streak-updated');setTimeout(()=>element.classList.remove('streak-updated'),2000);}}});}startAutoCheck(){this.checkInterval=setInterval(()=>{this.checkForNewAchievements();},30000);setTimeout(()=>this.checkForNewAchievements(),2000);}async checkForNewAchievements(){try{const response=await fetch('/achievements/api/check',{method:'POST'});const data=await response.json();if(data.success&&data.data.newAchievements.length>0){console.log('[ACHIEVEMENTS]Novas conquistas encontradas:',data.data.newAchievements.length);data.data.newAchievements.forEach((achievement,index)=>{setTimeout(()=>{this.showAchievementUnlocked(achievement);},index*3000);});}}catch(error){console.error('[ACHIEVEMENTS]Erro ao verificar conquistas:',error);}}showAchievementUnlocked(achievement){this.updateAchievementCard(achievement);this.showAchievementModal(achievement);this.playAchievementSound();this.showConfetti();this.updateStats();}showAchievementModal(achievement){const modal=this.modal;if(!modal)return;modal.querySelector('.modal-title').textContent='üéâ Conquista Desbloqueada!';modal.querySelector('.modal-achievement-icon').textContent=achievement.icon;modal.querySelector('.modal-achievement-name').textContent=achievement.name;modal.querySelector('.modal-achievement-description').textContent=achievement.description;modal.querySelector('.xp-amount').textContent=`+${achievement.xp_reward}XP`;this.showModal();setTimeout(()=>{if(modal.classList.contains('show')){this.hideModal();}},5000);}showModal(){if(this.modal){this.modal.classList.add('show');document.body.style.overflow='hidden';}}hideModal(){if(this.modal){this.modal.classList.remove('show');document.body.style.overflow='';}}updateAchievementCard(achievement){const card=document.querySelector(`[data-achievement-id="${achievement.id}"]`);if(card){card.classList.add('unlocked');card.classList.add('newly-unlocked');const badge=card.querySelector('.achievement-badge');if(badge){badge.innerHTML='<span class="badge-unlocked">‚úì</span>';}const progressSection=card.querySelector('.achievement-progress');if(progressSection){progressSection.remove();}const content=card.querySelector('.achievement-content');if(content&&!content.querySelector('.achievement-unlocked-date')){const dateElement=document.createElement('div');dateElement.className='achievement-unlocked-date';dateElement.textContent=`Desbloqueada agora mesmo!`;content.appendChild(dateElement);}setTimeout(()=>{card.classList.remove('newly-unlocked');},3000);}}playAchievementSound(){const audio=document.createElement('audio');audio.volume=0.3;try{const audioContext=new(window.AudioContext||window.webkitAudioContext)();const oscillator=audioContext.createOscillator();const gainNode=audioContext.createGain();oscillator.connect(gainNode);gainNode.connect(audioContext.destination);oscillator.frequency.setValueAtTime(523.25,audioContext.currentTime);oscillator.frequency.setValueAtTime(659.25,audioContext.currentTime+0.1);oscillator.frequency.setValueAtTime(783.99,audioContext.currentTime+0.2);gainNode.gain.setValueAtTime(0.3,audioContext.currentTime);gainNode.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+0.5);oscillator.start(audioContext.currentTime);oscillator.stop(audioContext.currentTime+0.5);}catch(error){console.log('[ACHIEVEMENTS]Som n√£o dispon√≠vel:',error);}}showConfetti(){const confettiContainer=document.createElement('div');confettiContainer.className='confetti-container';document.body.appendChild(confettiContainer);for(let i=0;i<50;i++){const confetti=document.createElement('div');confetti.className='confetti-piece';confetti.style.left=Math.random()*100+'%';confetti.style.backgroundColor=this.getRandomColor();confetti.style.animationDelay=Math.random()*2+'s';confetti.style.animationDuration=(Math.random()*3+2)+'s';confettiContainer.appendChild(confetti);}setTimeout(()=>{confettiContainer.remove();},5000);}getRandomColor(){const colors=['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEAA7','#DDA0DD','#98D8C8'];return colors[Math.floor(Math.random()*colors.length)];}async updateStats(){try{const response=await fetch('/achievements/api/stats');const data=await response.json();if(data.success){const stats=data.data.achievementStats;const unlockedElement=document.querySelector('.stat-number');const percentageElement=document.querySelector('.stat-card .stat-number');if(unlockedElement){unlockedElement.textContent=stats.unlocked_achievements;}const progressFill=document.querySelector('.progress-fill');if(progressFill){progressFill.style.width=`${stats.completion_percentage}%`;}}}catch(error){console.error('[ACHIEVEMENTS]Erro ao atualizar estat√≠sticas:',error);}}showLoading(){if(this.loadingOverlay){this.loadingOverlay.style.display='flex';}}hideLoading(){if(this.loadingOverlay){this.loadingOverlay.style.display='none';}}destroy(){if(this.checkInterval){clearInterval(this.checkInterval);}}}let achievementManager;document.addEventListener('DOMContentLoaded',()=>{achievementManager=new AchievementManager();});window.addEventListener('beforeunload',()=>{if(achievementManager){achievementManager.destroy();}});