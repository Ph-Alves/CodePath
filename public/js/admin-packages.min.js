class AdminPackagesManager{constructor(){this.packages=[];this.filteredPackages=[];this.currentEditingId=null;this.init();}init(){this.bindEvents();this.loadPackages();}bindEvents(){document.getElementById('addPackageBtn').addEventListener('click',()=>this.openAddModal());document.getElementById('refreshBtn').addEventListener('click',()=>this.loadPackages());document.getElementById('closeModal').addEventListener('click',()=>this.closeModal());document.getElementById('cancelBtn').addEventListener('click',()=>this.closeModal());document.getElementById('packageForm').addEventListener('submit',(e)=>this.handleFormSubmit(e));document.getElementById('confirmCancel').addEventListener('click',()=>this.closeConfirmModal());document.getElementById('confirmAction').addEventListener('click',()=>this.executeConfirmedAction());document.getElementById('statusFilter').addEventListener('change',()=>this.applyFilters());document.getElementById('difficultyFilter').addEventListener('change',()=>this.applyFilters());document.getElementById('searchFilter').addEventListener('input',()=>this.applyFilters());document.querySelectorAll('.modal').forEach(modal=>{modal.addEventListener('click',(e)=>{if(e.target===modal){this.closeModal();this.closeConfirmModal();}});});document.addEventListener('keydown',(e)=>{if(e.key==='Escape'){this.closeModal();this.closeConfirmModal();}});}async loadPackages(){try{this.showTableLoading(!0);const response=await fetch('/admin/api/packages');const data=await response.json();if(data.success){this.packages=data.packages;this.filteredPackages=[...this.packages];this.renderPackagesTable();this.updateStats();}else{this.showToast('Erro ao carregar pacotes','error');}}catch(error){console.error('Erro ao carregar pacotes:',error);this.showToast('Erro de conexão','error');}finally{this.showTableLoading(!1);}}renderPackagesTable(){const tbody=document.getElementById('packagesTableBody');const emptyState=document.getElementById('emptyState');if(this.filteredPackages.length===0){tbody.innerHTML='';emptyState.style.display='block';return;}emptyState.style.display='none';tbody.innerHTML=this.filteredPackages.map(pkg=>`<tr data-package-id="${pkg.id}" class="${pkg.is_active?'active':'inactive'}"><td class="package-id">${pkg.id}</td><td class="package-name"><div class="package-info"><strong>${this.escapeHtml(pkg.name)}</strong><small>${this.escapeHtml(pkg.description)}</small></div></td><td class="package-difficulty"><span class="difficulty-badge difficulty-${pkg.difficulty}">${pkg.difficulty}</span></td><td class="package-duration">${pkg.duration_hours}h</td><td class="package-lessons">${pkg.lesson_count||0}</td><td class="package-rating"><div class="rating-display"><span class="rating-value">${pkg.rating||0}</span><div class="rating-stars"><i class="fas fa-star"></i></div></div></td><td class="package-status">${pkg.is_active?'<span class="status-badge status-active"><i class="fas fa-check-circle"></i>Ativo</span>':'<span class="status-badge status-inactive"><i class="fas fa-pause-circle"></i>Inativo</span>'}</td><td class="package-actions"><div class="action-buttons"><button class="btn-action btn-edit" data-id="${pkg.id}" title="Editar"><i class="fas fa-edit"></i></button>${pkg.is_active?`<button class="btn-action btn-delete" data-id="${pkg.id}" title="Desativar"><i class="fas fa-pause"></i></button>`:`<button class="btn-action btn-reactivate" data-id="${pkg.id}" title="Reativar"><i class="fas fa-play"></i></button>`}</div></td></tr>`).join('');this.bindActionButtons();}bindActionButtons(){document.querySelectorAll('.btn-edit').forEach(btn=>{btn.addEventListener('click',(e)=>{const id=e.currentTarget.getAttribute('data-id');this.openEditModal(parseInt(id));});});document.querySelectorAll('.btn-delete').forEach(btn=>{btn.addEventListener('click',(e)=>{const id=e.currentTarget.getAttribute('data-id');this.confirmDelete(parseInt(id));});});document.querySelectorAll('.btn-reactivate').forEach(btn=>{btn.addEventListener('click',(e)=>{const id=e.currentTarget.getAttribute('data-id');this.confirmReactivate(parseInt(id));});});}applyFilters(){const statusFilter=document.getElementById('statusFilter').value;const difficultyFilter=document.getElementById('difficultyFilter').value;const searchFilter=document.getElementById('searchFilter').value.toLowerCase();this.filteredPackages=this.packages.filter(pkg=>{if(statusFilter!==''&&pkg.is_active.toString()!==statusFilter){return !1;}if(difficultyFilter!==''&&pkg.difficulty!==difficultyFilter){return !1;}if(searchFilter!==''&&!pkg.name.toLowerCase().includes(searchFilter)&&!pkg.description.toLowerCase().includes(searchFilter)){return !1;}return !0;});this.renderPackagesTable();}openAddModal(){this.currentEditingId=null;document.getElementById('modalTitle').textContent='Novo Pacote';document.getElementById('packageForm').reset();document.getElementById('packageActive').checked=!0;this.openModal();}async openEditModal(packageId){try{this.currentEditingId=packageId;document.getElementById('modalTitle').textContent='Editar Pacote';const response=await fetch(`/admin/api/packages/${packageId}`);const data=await response.json();if(data.success){const pkg=data.package;document.getElementById('packageName').value=pkg.name;document.getElementById('packageDescription').value=pkg.description;document.getElementById('packageDifficulty').value=pkg.difficulty;document.getElementById('packageDuration').value=pkg.duration_hours;document.getElementById('packageRating').value=pkg.rating||'';document.getElementById('packageTags').value=pkg.tags||'';document.getElementById('packagePrerequisites').value=pkg.prerequisites||'';document.getElementById('packageImageUrl').value=pkg.image_url||'';document.getElementById('packageActive').checked=pkg.is_active;this.openModal();}else{this.showToast('Erro ao carregar dados do pacote','error');}}catch(error){console.error('Erro ao carregar pacote:',error);this.showToast('Erro de conexão','error');}}openModal(){document.getElementById('packageModal').classList.add('active');document.body.style.overflow='hidden';}closeModal(){document.getElementById('packageModal').classList.remove('active');document.body.style.overflow='';this.currentEditingId=null;}async handleFormSubmit(e){e.preventDefault();const formData=new FormData(e.target);const packageData={name:formData.get('name'),description:formData.get('description'),difficulty:formData.get('difficulty'),duration_hours:parseInt(formData.get('duration_hours')),rating:formData.get('rating')?parseFloat(formData.get('rating')):null,tags:formData.get('tags'),prerequisites:formData.get('prerequisites'),image_url:formData.get('image_url'),is_active:formData.has('is_active')};try{const isEditing=this.currentEditingId!==null;const url=isEditing?`/admin/api/packages/${this.currentEditingId}`:'/admin/api/packages';const method=isEditing?'PUT':'POST';const response=await fetch(url,{method:method,headers:{'Content-Type':'application/json'},body:JSON.stringify(packageData)});const data=await response.json();if(data.success){this.showToast(isEditing?'Pacote atualizado com sucesso':'Pacote criado com sucesso','success');this.closeModal();this.loadPackages();}else{this.showToast(data.message||'Erro ao salvar pacote','error');}}catch(error){console.error('Erro ao salvar pacote:',error);this.showToast('Erro de conexão','error');}}confirmDelete(packageId){const pkg=this.packages.find(p=>p.id===packageId);if(!pkg)return;this.showConfirmModal('Desativar Pacote',`Tem certeza que deseja desativar o pacote "${pkg.name}"?`,()=>this.deletePackage(packageId));}confirmReactivate(packageId){const pkg=this.packages.find(p=>p.id===packageId);if(!pkg)return;this.showConfirmModal('Reativar Pacote',`Tem certeza que deseja reativar o pacote "${pkg.name}"?`,()=>this.reactivatePackage(packageId));}async deletePackage(packageId){try{const response=await fetch(`/admin/api/packages/${packageId}`,{method:'DELETE'});const data=await response.json();if(data.success){this.showToast(data.message,'success');this.loadPackages();}else{this.showToast(data.message||'Erro ao desativar pacote','error');}}catch(error){console.error('Erro ao desativar pacote:',error);this.showToast('Erro de conexão','error');}}async reactivatePackage(packageId){try{const response=await fetch(`/admin/api/packages/${packageId}/reactivate`,{method:'PATCH'});const data=await response.json();if(data.success){this.showToast(data.message,'success');this.loadPackages();}else{this.showToast(data.message||'Erro ao reativar pacote','error');}}catch(error){console.error('Erro ao reativar pacote:',error);this.showToast('Erro de conexão','error');}}showConfirmModal(title,message,action){document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmMessage').textContent=message;this.pendingAction=action;document.getElementById('confirmModal').classList.add('active');document.body.style.overflow='hidden';}closeConfirmModal(){document.getElementById('confirmModal').classList.remove('active');document.body.style.overflow='';this.pendingAction=null;}executeConfirmedAction(){if(this.pendingAction){this.pendingAction();this.closeConfirmModal();}}updateStats(){const stats={total_packages:this.packages.length,active_packages:this.packages.filter(p=>p.is_active).length,inactive_packages:this.packages.filter(p=>!p.is_active).length,avg_duration:this.packages.length>0?Math.round(this.packages.reduce((sum,p)=>sum+p.duration_hours,0)/this.packages.length):0};document.querySelector('.stat-card:nth-child(1).stat-number').textContent=stats.total_packages;document.querySelector('.stat-card:nth-child(2).stat-number').textContent=stats.active_packages;document.querySelector('.stat-card:nth-child(3).stat-number').textContent=stats.inactive_packages;document.querySelector('.stat-card:nth-child(4).stat-number').textContent=`${stats.avg_duration}h`;}showTableLoading(show){const loading=document.getElementById('tableLoading');loading.style.display=show?'flex':'none';}showToast(message,type='info'){const toast=document.getElementById('toast');const toastMessage=toast.querySelector('.toast-message');const toastIcon=toast.querySelector('.toast-icon');toast.classList.remove('success','error','warning','show');toast.classList.add(type);let icon='fas fa-info-circle';if(type==='success')icon='fas fa-check-circle';else if(type==='error')icon='fas fa-exclamation-circle';else if(type==='warning')icon='fas fa-exclamation-triangle';toastIcon.className=`toast-icon ${icon}`;toastMessage.textContent=message;toast.classList.add('show');setTimeout(()=>{toast.classList.remove('show');},5000);}escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}}document.addEventListener('DOMContentLoaded',()=>{new AdminPackagesManager();});