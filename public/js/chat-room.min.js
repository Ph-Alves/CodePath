let messagePollingInterval;let currentMessageType='text';let lastMessageId=0;let isPolling=!1;let isSending=!1;let mockMessageInterval;let typingSimulationInterval;let mockUsers=[];let mockMessageTemplates=[];document.addEventListener('DOMContentLoaded',function(){console.log('🚀 Sala de Chat iniciada');setupEventListeners();initializeChatRoom();setupMockData();startRealtimeSimulation();startMessagePolling();setupAutoResize();});function setupMockData(){mockUsers=[{id:2,name:'Ana Silva',avatar:'👩‍💻',status:'online'},{id:3,name:'Carlos Santos',avatar:'👨‍💻',status:'online'},{id:4,name:'Maria Oliveira',avatar:'👩‍🎓',status:'away'},{id:5,name:'João Costa',avatar:'👨‍🎓',status:'online'},{id:6,name:'Fernanda Lima',avatar:'👩‍💼',status:'online'},{id:7,name:'Pedro Alves',avatar:'👨‍💼',status:'away'}];mockMessageTemplates=["Alguém pode me ajudar com esse erro que estou enfrentando?","Acabei de terminar o exercício!Foi mais difícil do que esperava 🎉","Qual seria a melhor forma de implementar essa funcionalidade?","Muito obrigado pela ajuda pessoal!Vocês são incríveis 🙏","Estou com dificuldade para entender esse conceito...","Encontrei um artigo interessante sobre isso:https:"Alguém quer formar um grupo de estudos para esta semana?","Consegui resolver!Era só um erro de sintaxe 😅","Pessoal,alguém mais está online para tirar dúvidas?","Boa noite pessoal!Até amanhã nos estudos 👋","Compartilhando minha solução para o exercício anterior","Essa aula foi muito esclarecedora,recomendo!","Tem algum material complementar sobre esse tópico?","Vou fazer uma pausa para o café ☕ Volto já!","Alguém já fez o quiz desta seção?","Dica:sempre testem o código antes de submeter!","Estou progredindo bem nesta trilha 📈","Quem mais está fazendo o curso completo?","Vamos marcar um estudo em grupo para amanhã?","Parabéns pessoal pelo progresso!🚀"];console.log('📊 Dados mockados configurados para sala:',mockUsers.length,'usuários');}function startRealtimeSimulation(){mockMessageInterval=setInterval(()=>{if(!document.hidden&&Math.random()>0.3){simulateNewMessage();}},Math.random()*25000+20000);typingSimulationInterval=setInterval(()=>{if(!document.hidden&&Math.random()>0.7){simulateTypingIndicator();}},Math.random()*15000+10000);console.log('🎭 Simulação de tempo real iniciada');}function simulateNewMessage(){const randomUser=mockUsers[Math.floor(Math.random()*mockUsers.length)];const randomTemplate=mockMessageTemplates[Math.floor(Math.random()*mockMessageTemplates.length)];const mockMessage={id:Date.now(),user_id:randomUser.id,user_name:randomUser.name,user_avatar:randomUser.avatar,message:randomTemplate,message_type:Math.random()>0.9?'code':'text',created_at:new Date().toISOString(),is_own:!1};if(mockMessage.message_type==='code'){const codeExamples=["function hello(){\n console.log('Hello World!');\n}","for(let i=0;i<10;i++){\n console.log(i);\n}","const array=[1,2,3];\nconst doubled=array.map(x=>x*2);","if(condition){\n return !0;\n}else{\n return !1;\n}","const fetchData=async()=>{\n const response=await fetch('/api/data');\n return response.json();\n};"];mockMessage.message=codeExamples[Math.floor(Math.random()*codeExamples.length)];}addMessageToList(mockMessage);if(isScrolledToBottom()){scrollToBottom();}updatePageTitle();console.log('💬 Mensagem simulada adicionada:',randomUser.name);}function simulateTypingIndicator(){const typingContainer=document.getElementById('typingIndicators');if(!typingContainer)return;const existingIndicators=typingContainer.querySelectorAll('.typing-indicator');if(existingIndicators.length>=2)return;const randomUser=mockUsers[Math.floor(Math.random()*mockUsers.length)];const existingUserIndicator=Array.from(existingIndicators).find(indicator=>indicator.dataset.userId===randomUser.id.toString());if(existingUserIndicator)return;const typingIndicator=document.createElement('div');typingIndicator.className='typing-indicator';typingIndicator.dataset.userId=randomUser.id;typingIndicator.innerHTML=`<div class="typing-user"><span class="user-avatar">${randomUser.avatar}</span><span class="user-name">${randomUser.name}</span><span class="typing-text">está digitando</span></div><div class="typing-dots"><span></span><span></span><span></span></div>`;typingContainer.appendChild(typingIndicator);scrollToBottom();setTimeout(()=>{if(typingIndicator.parentNode){typingIndicator.style.animation='fadeOut 0.3s ease forwards';setTimeout(()=>{typingIndicator.remove();},300);}},Math.random()*5000+3000);}function updatePageTitle(){const originalTitle=document.title;if(!originalTitle.includes('(')){document.title=`(1)${originalTitle}`;setTimeout(()=>{document.title=originalTitle;},3000);}}function pauseRealtimeSimulation(){if(mockMessageInterval){clearInterval(mockMessageInterval);mockMessageInterval=null;}if(typingSimulationInterval){clearInterval(typingSimulationInterval);typingSimulationInterval=null;}console.log('⏸️ Simulação pausada');}function resumeRealtimeSimulation(){if(!mockMessageInterval||!typingSimulationInterval){startRealtimeSimulation();console.log('▶️ Simulação retomada');}}function setupEventListeners(){const messageInput=document.getElementById('messageInput');const messageForm=document.getElementById('messageForm');if(messageInput){messageInput.addEventListener('input',handleMessageInput);messageInput.addEventListener('keydown',handleMessageKeydown);messageInput.addEventListener('input',debounce(showUserTyping,300));}const messagesContainer=document.getElementById('messagesContainer');if(messagesContainer){messagesContainer.addEventListener('scroll',handleMessagesScroll);}document.addEventListener('visibilitychange',handleVisibilityChange);const sendButton=document.getElementById('sendButton');if(sendButton){sendButton.addEventListener('click',(e)=>{e.preventDefault();sendMessage(e);});}const toggleTypeButton=document.getElementById('toggleMessageType');if(toggleTypeButton){toggleTypeButton.addEventListener('click',toggleMessageType);}}function initializeChatRoom(){console.log('📊 Inicializando sala de chat:',window.chatRoomData);scrollToBottom();const messages=document.querySelectorAll('.message[data-message-id]');if(messages.length>0){const lastMessage=messages[messages.length-1];lastMessageId=parseInt(lastMessage.dataset.messageId)||0;}const messageInput=document.getElementById('messageInput');if(messageInput){messageInput.focus();}updateCharacterCount();updateSendButton();ensureTypingContainer();}function ensureTypingContainer(){const messagesContainer=document.getElementById('messagesContainer');if(!messagesContainer)return;let typingContainer=document.getElementById('typingIndicators');if(!typingContainer){typingContainer=document.createElement('div');typingContainer.id='typingIndicators';typingContainer.className='typing-indicators';messagesContainer.appendChild(typingContainer);}}async function sendMessage(event){event.preventDefault();if(isSending)return;const messageInput=document.getElementById('messageInput');const message=messageInput.value.trim();if(!message)return;try{isSending=!0;showMessageLoading(!0);await new Promise(resolve=>setTimeout(resolve,500));const response=await fetch(`/chat/api/rooms/${window.chatRoomData.roomId}/messages`,{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({message:message,messageType:currentMessageType})});const data=await response.json();if(data.success){messageInput.value='';updateCharacterCount();updateSendButton();addMessageToList(data.message);scrollToBottom();lastMessageId=Math.max(lastMessageId,data.message.id);showMessageSuccess();}else{showError(data.message||'Erro ao enviar mensagem');}}catch(error){console.error('Erro ao enviar mensagem:',error);const mockSentMessage={id:Date.now(),user_id:window.chatRoomData.userId||1,user_name:window.chatRoomData.userName||'Você',user_avatar:'👤',message:message,message_type:currentMessageType,created_at:new Date().toISOString(),is_own:!0};messageInput.value='';updateCharacterCount();updateSendButton();addMessageToList(mockSentMessage);scrollToBottom();showSuccess('Mensagem enviada(modo simulação)');}finally{isSending=!1;showMessageLoading(!1);hideUserTyping();}}function showMessageSuccess(){const sendButton=document.getElementById('sendButton');if(sendButton){const originalContent=sendButton.innerHTML;sendButton.innerHTML='<i class="fas fa-check"></i>';sendButton.style.background='var(--success-color)';setTimeout(()=>{sendButton.innerHTML=originalContent;sendButton.style.background='';},1000);}}function startMessagePolling(){if(messagePollingInterval){clearInterval(messagePollingInterval);}messagePollingInterval=setInterval(async()=>{if(!isPolling&&!document.hidden){await pollNewMessages();}},3000);console.log('📡 Polling de mensagens iniciado');}async function pollNewMessages(){if(isPolling)return;try{isPolling=!0;const response=await fetch(`/chat/api/rooms/${window.chatRoomData.roomId}/messages?since=${lastMessageId}&limit=10`);const data=await response.json();if(data.success&&data.messages&&data.messages.length>0){data.messages.forEach(message=>{addMessageToList(message);lastMessageId=Math.max(lastMessageId,message.id);});if(isScrolledToBottom()){scrollToBottom();}}}catch(error){console.error('Erro no polling de mensagens:',error);}finally{isPolling=!1;}}function addMessageToList(message){const messagesList=document.getElementById('messagesList');const emptyState=messagesList.querySelector('.empty-messages');if(emptyState){emptyState.remove();}const existingMessage=messagesList.querySelector(`[data-message-id="${message.id}"]`);if(existingMessage)return;const messageElement=createMessageElement(message);const typingContainer=document.getElementById('typingIndicators');if(typingContainer){messagesList.insertBefore(messageElement,typingContainer);}else{messagesList.appendChild(messageElement);}messageElement.style.opacity='0';messageElement.style.transform='translateY(20px)';setTimeout(()=>{messageElement.style.transition='all 0.3s ease';messageElement.style.opacity='1';messageElement.style.transform='translateY(0)';},50);}function createMessageElement(message){const messageDiv=document.createElement('div');messageDiv.className=`message ${message.is_own?'own-message':'other-message'}`;messageDiv.dataset.messageId=message.id;messageDiv.dataset.userId=message.user_id;const messageTime=formatMessageTime(message.created_at);const messageContent=message.message_type==='code'?`<pre><code>${escapeHtml(message.message)}</code></pre>`:escapeHtml(message.message).replace(/\n/g,'<br>');messageDiv.innerHTML=`<div class="message-header"><span class="user-avatar">${message.user_avatar||'👤'}</span><span class="user-name">${escapeHtml(message.user_name)}</span><span class="message-time">${messageTime}</span>${message.message_type==='code'?'<span class="message-type-badge">CODE</span>':''}</div><div class="message-content ${message.message_type==='code'?'code-message':''}">${messageContent}</div>${message.is_own?'<div class="message-status"><i class="fas fa-check"></i></div>':''}`;return messageDiv;}function showUserTyping(){console.log('👤 Usuário está digitando...');}function hideUserTyping(){console.log('👤 Usuário parou de digitar');}function toggleMessageType(){const toggleButton=document.getElementById('toggleMessageType');const messageInput=document.getElementById('messageInput');if(currentMessageType==='text'){currentMessageType='code';toggleButton.innerHTML='<i class="fas fa-font"></i>';toggleButton.title='Alternar para texto';messageInput.placeholder='Digite seu código aqui...';messageInput.style.fontFamily='monospace';}else{currentMessageType='text';toggleButton.innerHTML='<i class="fas fa-code"></i>';toggleButton.title='Alternar para código';messageInput.placeholder='Digite sua mensagem...';messageInput.style.fontFamily='';}toggleButton.style.animation='pulse 0.3s ease';setTimeout(()=>{toggleButton.style.animation='';},300);}function toggleMembersList(){const membersList=document.getElementById('membersList');const toggleButton=document.getElementById('toggleMembers');if(membersList.style.display==='none'||!membersList.style.display){membersList.style.display='block';toggleButton.innerHTML='<i class="fas fa-times"></i>';membersList.style.animation='slideIn 0.3s ease';}else{membersList.style.display='none';toggleButton.innerHTML='<i class="fas fa-users"></i>';}}async function leaveChatRoom(roomId){if(!confirm('Tem certeza que deseja sair desta sala?')){return;}try{showLoading();const response=await fetch(`/chat/api/rooms/${roomId}/leave`,{method:'POST',headers:{'Content-Type':'application/json',}});const data=await response.json();if(data.success){showSuccess('Você saiu da sala. Redirecionando...');setTimeout(()=>{window.location.href='/chat';},1500);}else{showError(data.message||'Erro ao sair da sala');}}catch(error){console.error('Erro ao sair da sala:',error);showSuccess('Saindo da sala...(modo simulação)');setTimeout(()=>{window.location.href='/chat';},1500);}finally{hideLoading();}}function handleMessageInput(event){updateCharacterCount();updateSendButton();autoResizeTextarea(event.target);}function handleMessageKeydown(event){if((event.ctrlKey||event.metaKey)&&event.key==='Enter'){event.preventDefault();sendMessage(event);}if(event.shiftKey&&event.key==='Enter'){return;}if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage(event);}}function updateCharacterCount(){const messageInput=document.getElementById('messageInput');const charCount=document.getElementById('characterCount');if(messageInput&&charCount){const currentLength=messageInput.value.length;const maxLength=1000;charCount.textContent=`${currentLength}/${maxLength}`;if(currentLength>maxLength*0.9){charCount.style.color='var(--error-color)';}else if(currentLength>maxLength*0.7){charCount.style.color='var(--warning-color)';}else{charCount.style.color='var(--text-muted)';}}}function updateSendButton(){const messageInput=document.getElementById('messageInput');const sendButton=document.getElementById('sendButton');if(messageInput&&sendButton){const hasContent=messageInput.value.trim().length>0;sendButton.disabled=!hasContent||isSending;if(hasContent&&!isSending){sendButton.classList.add('active');}else{sendButton.classList.remove('active');}}}function setupAutoResize(){const messageInput=document.getElementById('messageInput');if(messageInput){messageInput.style.minHeight=messageInput.scrollHeight+'px';}}function autoResizeTextarea(textarea){textarea.style.height='auto';const newHeight=Math.min(textarea.scrollHeight,120);textarea.style.height=newHeight+'px';}function scrollToBottom(){const messagesContainer=document.getElementById('messagesContainer');if(messagesContainer){messagesContainer.scrollTop=messagesContainer.scrollHeight;}}function isScrolledToBottom(){const messagesContainer=document.getElementById('messagesContainer');if(!messagesContainer)return !1;const threshold=100;return messagesContainer.scrollHeight-messagesContainer.clientHeight<=messagesContainer.scrollTop+threshold;}function handleMessagesScroll(event){const container=event.target;const scrollTop=container.scrollTop;const scrollButton=document.getElementById('scrollToBottomButton');if(scrollButton){if(isScrolledToBottom()){scrollButton.style.display='none';}else{scrollButton.style.display='block';}}}function handleVisibilityChange(){if(document.hidden){pauseRealtimeSimulation();if(messagePollingInterval){clearInterval(messagePollingInterval);messagePollingInterval=null;}}else{resumeRealtimeSimulation();if(!messagePollingInterval){startMessagePolling();}}}function showMessageLoading(show){const sendButton=document.getElementById('sendButton');if(sendButton){if(show){sendButton.innerHTML='<i class="fas fa-spinner fa-spin"></i>';sendButton.disabled=!0;}else{sendButton.innerHTML='<i class="fas fa-paper-plane"></i>';updateSendButton();}}}function showLoading(){console.log('🔄 Carregando...');}function hideLoading(){console.log('✅ Carregamento concluído');}function showSuccess(message){showNotification(message,'success');}function showError(message){showNotification(message,'error');}function showInfo(message){showNotification(message,'info');}function showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`chat-notification ${type}`;notification.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i><span>${message}</span>`;let container=document.getElementById('chatNotifications');if(!container){container=document.createElement('div');container.id='chatNotifications';container.className='chat-notifications';document.body.appendChild(container);}container.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.style.animation='slideOut 0.3s ease forwards';setTimeout(()=>{notification.remove();},300);}},3000);}function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}function formatMessageTime(timestamp){const date=new Date(timestamp);const now=new Date();const diffMs=now-date;const diffMins=Math.floor(diffMs/60000);const diffHours=Math.floor(diffMs/3600000);const diffDays=Math.floor(diffMs/86400000);if(diffMins<1){return 'agora';}else if(diffMins<60){return `${diffMins}min`;}else if(diffHours<24){return `${diffHours}h`;}else if(diffDays<7){return `${diffDays}d`;}else{return date.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});}}function debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout=setTimeout(later,wait);};}window.addEventListener('beforeunload',function(){pauseRealtimeSimulation();if(messagePollingInterval){clearInterval(messagePollingInterval);}});window.sendMessage=sendMessage;window.toggleMessageType=toggleMessageType;window.toggleMembersList=toggleMembersList;window.leaveChatRoom=leaveChatRoom;window.scrollToBottom=scrollToBottom;